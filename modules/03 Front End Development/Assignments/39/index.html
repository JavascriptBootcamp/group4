<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>HTML 39</title>
</head>

<body onload="initProducts()">
    <table border='1'>
        <tr>
            <th>Name
                <select id='items' onchange="updateSelection()">

                </select>
            </th>
            <th>Price
                <input type="number" name="price" id="price" pattern="[0-9]*" min='1' oninput="updatePrice()" />
            </th>
            <th>Action
                <button onclick="addItem()">Add</button>
            </th>
        </tr>
    </table>
    <br />
    <div id="total"></div>
    <br />
    <hr />
    <form action="http://localhost:3000/Order" method="post">
        <label for="card">Card Number: </label>
        <input type="number" name="card" id="cardNum" required>
        <label for="name">Name on card: </label>
        <input type="text" name="name" id="name" required>
        <label for="date">Expiry date: </label>
        <input type="date" name="date" id="expDate" required>
        <label for="code">Security code: </label>
        <input type="password" name="code" id="code" minlength="3" maxlength="3" pattern='[0-9]*' required>
        <button type="button" onclick="validateCard()">Submit</button>
    </form>
    <div id="result"></div>
    <script>
        var products = {
            apple: "4",
            candy: "1",
            water: "25",
            carrot: "3",
            umbrella: "10",
            proteinShake: "22",
            laptop: "3500",
            book: "78",
            beer: "25"
        };

        function initProducts() {
            var items = document.getElementById('items');
            var price = document.getElementById('price');
            var count = 0;
            for (key in products) {
                count++;
                var item = document.createElement('option');
                item.value = key;
                item.innerText = key;
                items.appendChild(item);
                if (count === 1) {
                    price.value = Number(products[key]);
                }
            }
        }
        function updateSelection() {
            var items = document.getElementById('items');
            var price = document.getElementById('price');
            var key = items.options[items.selectedIndex].text;
            price.value = Number(products[key]);
        }
        function addItem() {
            var items = document.getElementById('items');
            var price = document.getElementById('price');
            var table = document.getElementsByTagName('table')[0];
            var tr = document.createElement('tr');
            table.appendChild(tr);
            var td = document.createElement('td');
            td.innerText = items.options[items.selectedIndex].text;
            tr.appendChild(td);
            td = document.createElement('td');
            td.innerText = price.value;
            tr.appendChild(td);
            td = document.createElement('td');
            var btn = document.createElement('button');
            btn.setAttribute('class', 'removeBTN');
            btn.innerHTML = 'Remove';
            btn.onclick = removeItem;
            td.appendChild(btn);
            tr.appendChild(td);
            updateTotal(price.value);
        }
        function removeItem(event) {
            var table = document.getElementsByTagName('table')[0];
            var btn = event.target;
            var td = btn.parentNode;
            var tr = td.parentNode;
            var tdOfPrice = tr.childNodes[1];
            var priceValue = tdOfPrice.innerText;
            table.removeChild(tr);
            updateTotal('-' + priceValue);
        }
        function updateTotal(newItem) {
            var div = document.getElementById('total');
            var total = div.innerText.length !== 0 ? Number(div.innerText.substring(13)) : 0;
            total += Number(newItem);
            div.innerText = 'Total price: ' + total;
        }
        function updatePrice() {
            var items = document.getElementById('items');
            var price = document.getElementById('price');
            var key = items.options[items.selectedIndex].text;
            if (price.value === '') {
                price.value = Number(products[key]);
            } else {
                products[key] = price.value
            }
        }

        function validateCreditCard(creditCard) {
            var creditCardNumbers;
            var creditCardNumbersSum = 0;
            var creditCardWithNoDashes;

            creditCardWithNoDashes = creditCard.split("-");
            creditCardWithNoDashes = creditCardWithNoDashes.join("");
            creditCardNumbers = creditCardWithNoDashes.split("").map(Number);

            function checkLength(creditCardWithNoDashes) {
                return (creditCardWithNoDashes.length == 16);
            }

            function checkAllItemsNumbers(creditCardNumbers) {
                var isAllItemsNumbers = creditCardNumbers.every(function (element) {
                    creditCardNumbersSum += element;
                    return (element >= 0 && element <= 9);
                });

                return isAllItemsNumbers;
            }

            function checkDigitsSum() {
                return (creditCardNumbersSum > 16);
            }

            function checkIfAllDigitsSame(creditCardNumbers) {
                var isAllDigitsSame = creditCardNumbers.every(function (element) {
                    return element === creditCardNumbers[0];
                });
                return !isAllDigitsSame;
            }

            function CheckLastDigitEven(creditCardNumbers) {
                return (creditCardNumbers[creditCardNumbers.length - 1] % 2 == 0)
            }

            if (checkLength(creditCardNumbers)) {
                if (checkAllItemsNumbers(creditCardNumbers)) {
                    if (checkDigitsSum()) {
                        if (checkIfAllDigitsSame(creditCardNumbers)) {
                            if (CheckLastDigitEven(creditCardNumbers)) {
                                return { valid: true, number: creditCard }
                            }
                            else {
                                return { valid: false, error: "odd final number", number: creditCard }
                            }
                        }
                        else {
                            return { valid: false, error: "only one type of number", number: creditCard }
                        }
                    }
                    else {
                        return { valid: false, error: "sum less than 16", number: creditCard }
                    }
                }
                else {
                    return { valid: false, error: "invalid characters", number: creditCard }
                }
            }
            else {
                return { valid: false, error: "Credit Card Length Must Be 16 Digits", number: creditCard }
            }
        }

        function validateCard() {
            var cardNum = document.getElementById('cardNum');
            var validObj = validateCreditCard(cardNum.value);
            var divResult = document.getElementById('result');
            if(validObj.valid){
                divResult.innerHTML = '';
                var form = document.getElementsByTagName('form')[0];
                form.submit();
            } else {
                divResult.innerHTML = Object.keys(validObj)[0] + ' : ' + validObj.valid + '<br />';
                divResult.innerHTML += Object.keys(validObj)[1] + ' : ' + validObj.number + '<br />';
                divResult.innerHTML += Object.keys(validObj)[2] + ' : ' + validObj.error;
            }
        }

    </script>
</body>

</html>